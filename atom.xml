<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

 <title>[ts] not zi-hang</title>
 <link href="https://seanxwzhang.github.io/atom.xml" rel="self"/>
 <link href="https://seanxwzhang.github.io/"/>
 <updated>2016-10-05T17:37:42-07:00</updated>
 <id>https://seanxwzhang.github.io</id>
 <author>
   <name>Sean Xiaowen Zhang</name>
   <email>seanxwzhang@gmail.com</email>
 </author>


 <entry>
   <title>Mapping Docker container IP with Vagrant machine</title>
   <link href="https://seanxwzhang.github.io/2016/09/26/Docker-IP-mapping-with-Vagrant/"/>
   <updated>2016-09-26T00:00:00-07:00</updated>
   <id>https://seanxwzhang.github.io/2016/09/26/Docker-IP-mapping-with-Vagrant</id>
   <content type="html">&lt;p&gt;&lt;a href=&quot;https://docker.com&quot;&gt;Docker&lt;/a&gt; is a powerful software containerization tool that lets you create multiple self-contained kernel-free containers that share a single virtual machine. It is a very trendy tool that drew attention from lots of companies and developers. Here I’m not going to elaborate on how docker works, so if you are new to Docker, feel free to visit their website, they have maintained a great documentation.&lt;/p&gt;

&lt;p&gt;A few days ago, I need to write a script to automatically configure virtual environment and was hoping Docker could be of use. It turned out that it’s not trivial work to assign static IP to a docker container.&lt;/p&gt;

&lt;p&gt;I’m going to try to write this post in a most simple way such that it could benefit the readers with minimum amount of reading, by defining the &lt;strong&gt;problem&lt;/strong&gt; and &lt;strong&gt;solution&lt;/strong&gt; explicitly.&lt;/p&gt;

&lt;h2 id=&quot;problem&quot;&gt;Problem&lt;/h2&gt;

&lt;p&gt;I needed to access my docker container, which may be serving a website or running an application, from other computers in the same local network (e.g., home, office). Another constraint is that the container has to be accessible at the static local IP address assigned to me.&lt;/p&gt;

&lt;h2 id=&quot;solution&quot;&gt;Solution&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;This solution only applies to OSX users, however, with only minimum tweak, one should be able to easily get it working on Linux and Windows.&lt;/em&gt;&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Download &lt;a href=&quot;https://www.docker.com/products/docker-toolbox&quot;&gt;Docker Toolbox&lt;/a&gt; and install it. It comes with the following components.&lt;/p&gt;

    &lt;blockquote&gt;
      &lt;ul&gt;
        &lt;li&gt;Docker Machine for running docker-machine commands&lt;/li&gt;
        &lt;li&gt;Docker Engine for running the docker commands&lt;/li&gt;
        &lt;li&gt;Docker Compose for running the docker-compose commands&lt;/li&gt;
        &lt;li&gt;Kitematic, the Docker GUI&lt;/li&gt;
        &lt;li&gt;a shell preconfigured for a Docker command-line environment&lt;/li&gt;
        &lt;li&gt;Oracle VirtualBox&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Install &lt;a href=&quot;https://www.vagrantup.com/&quot;&gt;Vagrant&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Open &lt;code class=&quot;highlighter-rouge&quot;&gt;Docker Quickstart Terminal&lt;/code&gt;. This mini application starts the terminal after creating a linux virtual machine and running some additional configuration code. If you are using &lt;code class=&quot;highlighter-rouge&quot;&gt;iTerm&lt;/code&gt;, it’s likely that &lt;code class=&quot;highlighter-rouge&quot;&gt;Quickstart Terminal&lt;/code&gt; would not work properly, instead, try run the script &lt;a href=&quot;/public/code/docker_ip_mapping/docker_quickstart.sh&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Now, instead of using the default Docker machine created by the Quickstart script, we’re going to create our own Docker machine, using Vagrant. To create a Vagrant machine, refer to a sample Vagrantfile below.&lt;/p&gt;

    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; &lt;span class=&quot;c1&quot;&gt;# -*- mode: ruby -*-&lt;/span&gt;
 &lt;span class=&quot;c1&quot;&gt;# vi: set ft=ruby :&lt;/span&gt;
 &lt;span class=&quot;c1&quot;&gt;# Originally written by Xinyu Chen, modified by Xiaowen Zhang&lt;/span&gt;
 &lt;span class=&quot;no&quot;&gt;Vagrant&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;configure&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;

   &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;vm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;box&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ubuntu/trusty64&quot;&lt;/span&gt;

   &lt;span class=&quot;c1&quot;&gt;# Assign a friendly name to this host VM&lt;/span&gt;
     &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;vm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;hostname&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;vagrant-docker&quot;&lt;/span&gt;

   &lt;span class=&quot;c1&quot;&gt;# Create a private network, which allows host-only access to the machine using a specific IP.&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;vm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;network&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;private_network&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;ip: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;192.168.33.10&quot;&lt;/span&gt;

   &lt;span class=&quot;c1&quot;&gt;# Change the IP address to your assigned one [IMPORTANT].&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;vm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;network&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;public_network&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;ip: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;192.168.3.25&quot;&lt;/span&gt;

   &lt;span class=&quot;c1&quot;&gt;# Adjust number of CPUs and memory allocation here.&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;vm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;provider&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;virtualbox&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
     &lt;span class=&quot;n&quot;&gt;vb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;cpus&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;4&quot;&lt;/span&gt;
     &lt;span class=&quot;n&quot;&gt;vb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;memory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;4096&quot;&lt;/span&gt;
     &lt;span class=&quot;n&quot;&gt;vb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;customize&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;modifyvm&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;--ioapic&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;on&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
     &lt;span class=&quot;n&quot;&gt;vb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;customize&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;setextradata&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;VBoxInternal2/SharedFoldersEnableSymlinksCreate/v-root&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
   &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

   &lt;span class=&quot;c1&quot;&gt;# Always use Vagrant's default insecure key&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;ssh&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;insert_key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;

 &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Now you can run &lt;code class=&quot;highlighter-rouge&quot;&gt;vagrant up&lt;/code&gt; in the directory the vagrantfile resides. If everything goes well, when you do &lt;code class=&quot;highlighter-rouge&quot;&gt;vagrant ssh&lt;/code&gt;
, you should be able to see something like below, where the IP address is exactly what we configured.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/public/image/vagrant_output.png&quot; alt=&quot;Vagrant output&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Not only do we need the vm running, we have to tell Docker to use this machine as a Docker vm. Here’s how I did it, based on &lt;a href=&quot;http://blog.scottlowe.org/2015/08/04/using-vagrant-docker-machine-together/&quot;&gt;Scott’s Weblog&lt;/a&gt;&lt;/p&gt;

    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; docker-machine create -d generic \
 --generic-ssh-user vagrant \
 --generic-ssh-key ~/.vagrant.d/insecure_private_key \
 --generic-ip-address 192.168.33.10 \
 --engine-install-url &quot;https://test.docker.com&quot; \
 &amp;lt;name of the vm, up to you&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
    &lt;/div&gt;

    &lt;p&gt;Run the above in a terminal and after docker finishes creating the vm, run &lt;code class=&quot;highlighter-rouge&quot;&gt;docker-machine ls&lt;/code&gt;, and you should be able to see the vm running&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/public/image/vm_running.jpg&quot; alt=&quot;VM runing screenshot&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;After docker machine is created, we can run a docker container&lt;/p&gt;

    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; docker run -d -p 8080:80 nginx
&lt;/code&gt;&lt;/pre&gt;
    &lt;/div&gt;

    &lt;p&gt;Now we can use any computer in our local network to visit the nginx server that we just created that resides in a container running in a vagrant-based  vm on our computer!&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/public/image/ip_mapped_successful.png&quot; alt=&quot;Nginx running&quot; /&gt;&lt;/p&gt;

    &lt;p&gt;Done.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;
</content>
 </entry>

</feed>
