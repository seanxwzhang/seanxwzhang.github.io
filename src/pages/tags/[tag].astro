---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => !data.draft);

  // Get all unique tags
  const tags = [...new Set(posts.flatMap((post) => post.data.tags || []))];

  return tags.map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts.filter((post) => post.data.tags?.includes(tag)),
    },
  }));
}

interface Props {
  tag: string;
  posts: Awaited<ReturnType<typeof getCollection>>;
}

const { tag, posts } = Astro.props;
const sortedPosts = posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
---

<BaseLayout title={`Posts tagged "${tag}"`} description={`All posts tagged with ${tag}`}>
  <div class="mb-8">
    <a href="/tags" class="text-sm text-ink-muted hover:text-coral transition-colors">
      &larr; All tags
    </a>
  </div>

  <h1 class="font-serif text-4xl font-semibold text-ink mb-2">
    #{tag}
  </h1>
  <p class="text-ink-muted mb-8">
    {posts.length} {posts.length === 1 ? 'post' : 'posts'}
  </p>

  <div class="space-y-4">
    {sortedPosts.map((post) => {
      const formattedDate = new Date(post.data.date).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      });
      return (
        <article class="group">
          <a href={`/blog/${post.slug}`} class="block rounded-xl bg-white p-6 shadow-sm border border-cream-200 hover:shadow-md hover:border-coral/30 transition-all">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2">
              <h2 class="font-serif text-xl font-medium text-ink group-hover:text-coral transition-colors">
                {post.data.title}
              </h2>
              <time datetime={post.data.date.toISOString()} class="text-sm text-ink-muted shrink-0">
                {formattedDate}
              </time>
            </div>
            {post.data.description && (
              <p class="text-ink-light text-sm">
                {post.data.description}
              </p>
            )}
          </a>
        </article>
      );
    })}
  </div>
</BaseLayout>
